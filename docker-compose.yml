version: "3.9"

services:
  # üß± Base de donn√©es MySQL
  mysql-db:
    image: mysql:8
    container_name: mysql-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root        # ‚úÖ mot de passe root explicite
      MYSQL_DATABASE: charity_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql      # ‚úÖ Volume persistant
    networks:
      - charity-net

  # üîë Keycloak (avec import automatique du realm)
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloaks
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: dev-file     # ‚úÖ Base embarqu√©e persistante sur disque
    volumes:
      - keycloak_data:/opt/keycloak/data   # ‚úÖ Persistance locale
    ports:
      - "8080:8080"
    networks:
      - charity-net

  micronotif-service:
    build: ./micronotif  # Path to your micronotif project
    container_name: micronotif-service
    ports:

      - "8985:8985"

    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/micro_notif?allowPublicKeyRetrieval=true&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - eureka-server
      - mysql-db
    networks:
      - charity-net




  # üß† Eureka Server
  eureka-server:
    build: ./Eureka
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - charity-net

  # üë§ User Service
  user-service:
    build: ./user-service
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/user_micro?allowPublicKeyRetrieval=true&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - eureka-server
      - mysql-db
    networks:
      - charity-net
    # üåê Frontend Angular
  angular-front:
    build: ./charity   # ‚Üê dossier de ton projet Angular
    container_name: angular-front
    ports:
      - "8083:80"      # ‚úÖ ton app sera accessible sur http://localhost:8083
    depends_on:
      - keycloak
      - api-gateway
    networks:
      - charity-net

    # üì∞ Blog Service
  blog-service:
    build: ./blog
    container_name: blog-service
    ports:
      - "8989:8989"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/blog?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - eureka-server
      - mysql-db
    networks:
      - charity-net
  donation-service:
    build: ./donation
    container_name: donation-service
    ports:
      - "8282:8282"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/donation_db?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - mysql-db
    networks:
      - charity-net

  # üö™ API Gateway
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8980:8980"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      - eureka-server
      - user-service
    networks:
      - charity-net

  # üß© PhpMyAdmin
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    environment:
      PMA_HOST: mysql-db
      PMA_USER: root
      PMA_PASSWORD: root
    ports:
      - "8082:80"
    depends_on:
      - mysql-db
    networks:
      - charity-net

# üï∏Ô∏è R√©seau partag√© entre les services
networks:
  charity-net:
    driver: bridge

# üíæ Volumes persistants
volumes:
  mysql_data:
  keycloak_data:
